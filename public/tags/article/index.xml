<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>Article on Mischa van den Burg</title>
    <link>https://mischavandenburg.com/tags/article/</link>
    <description>Recent content in Article on Mischa van den Burg</description>
    <generator>Hugo -- gohugo.io</generator>
    <lastBuildDate>Sat, 21 Jan 2023 00:00:00 +0000</lastBuildDate><atom:link href="https://mischavandenburg.com/tags/article/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>Setting up a new LUKS encrypted disk with dm-crypt in Arch Linux</title>
      <link>https://mischavandenburg.com/zet/articles/new-luks-encrypted-disk/</link>
      <pubDate>Sat, 21 Jan 2023 00:00:00 +0000</pubDate>
      
      <guid>https://mischavandenburg.com/zet/articles/new-luks-encrypted-disk/</guid>
      <description>Today I added a harddisk I had lying around because I needed some more space. On my Arch Linux system I have all my drives encrypted like a good boy. It can be a bit tricky when you are adding them because you need to configure a few different files and add different UUID&amp;rsquo;s in each of them.
Here are the steps I follow to add a new disk. Note that this how to assumes that you already have set up your system with dm-crypt.</description>
      <content:encoded><![CDATA[<p>Today I added a harddisk I had lying around because I needed some more space. On my Arch Linux system I have all my drives encrypted like a good boy. It can be a bit tricky when you are adding them because you need to configure a few different files and add different UUID&rsquo;s in each of them.</p>
<p>Here are the steps I follow to add a new disk. Note that this how to assumes that you already have set up your system with dm-crypt.</p>
<p>List out the disks with lsblk:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">(</span>ins<span class="o">)[</span>mischa@arch-beast ~<span class="o">]</span>$ lsblk
</span></span><span class="line"><span class="cl">NAME          MAJ:MIN RM   SIZE RO TYPE  MOUNTPOINTS
</span></span><span class="line"><span class="cl">sda             8:0    <span class="m">0</span> 223.6G  <span class="m">0</span> disk
</span></span><span class="line"><span class="cl">└─sda1          8:1    <span class="m">0</span> 223.6G  <span class="m">0</span> part
</span></span><span class="line"><span class="cl">  └─games     254:0    <span class="m">0</span> 223.6G  <span class="m">0</span> crypt /games
</span></span><span class="line"><span class="cl">sdb             8:16   <span class="m">0</span> 931.5G  <span class="m">0</span> disk
</span></span><span class="line"><span class="cl">└─sdb1          8:17   <span class="m">0</span> 931.5G  <span class="m">0</span> part
</span></span><span class="line"><span class="cl">  └─data-hdd  254:2    <span class="m">0</span> 931.5G  <span class="m">0</span> crypt /data-hdd
</span></span><span class="line"><span class="cl">sdc             8:32   <span class="m">0</span> 931.5G  <span class="m">0</span> disk
</span></span><span class="line"><span class="cl">└─sdc1          8:33   <span class="m">0</span> 931.5G  <span class="m">0</span> part
</span></span><span class="line"><span class="cl">  └─data-hdd2 254:3    <span class="m">0</span> 931.5G  <span class="m">0</span> crypt /data-hdd2
</span></span><span class="line"><span class="cl">sdd             8:48   <span class="m">0</span> 465.8G  <span class="m">0</span> disk
</span></span><span class="line"><span class="cl">├─sdd1          8:49   <span class="m">0</span>   300M  <span class="m">0</span> part  /boot
</span></span><span class="line"><span class="cl">└─sdd2          8:50   <span class="m">0</span> 465.5G  <span class="m">0</span> part
</span></span><span class="line"><span class="cl">  └─root      254:1    <span class="m">0</span> 465.5G  <span class="m">0</span> crypt /
</span></span><span class="line"><span class="cl">sde             8:64   <span class="m">0</span> 931.5G  <span class="m">0</span> disk
</span></span><span class="line"><span class="cl">└─sde1          8:65   <span class="m">0</span> 931.5G  <span class="m">0</span> part
</span></span></code></pre></div><p>I will be adding /dev/sde to my system. As you see, I already created a partition on it, named <code>sde1</code>. The mountpoint for the disk will be <code>/data-hdd3</code>.</p>
<p>If you still need to add your partition, use <code>sudo gdisk /dev/sde</code> to write a new table and partition.</p>
<h2 id="encryption">encryption</h2>
<p>First I create the mount point I&rsquo;ll use and set the appropriate permisssions:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo mkdir /data-hdd3
</span></span><span class="line"><span class="cl">sudo chown mischa:mischa /data-hdd3
</span></span></code></pre></div><p>Now we create a LUKS header and an encrypted filesystem on the disk.
Note that I&rsquo;m using the notation convention from the Arch Wiki where the &ldquo;#&rdquo; indicates that the command should be run as root.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># cryptsetup -y -v luksFormat /dev/sde1</span>
</span></span><span class="line"><span class="cl"><span class="c1"># cryptsetup open /dev/sde1 data-hdd3 </span>
</span></span><span class="line"><span class="cl"><span class="c1"># mkfs.ext4 /dev/mapper/data-hdd3</span>
</span></span><span class="line"><span class="cl"><span class="c1"># mount /dev/mapper/data-hdd3 /data-hdd3</span>
</span></span></code></pre></div><p>Verify that it worked and the new encrypted partition is mounted:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">arch-beast# lsblk
</span></span><span class="line"><span class="cl">NAME          MAJ:MIN RM   SIZE RO TYPE  MOUNTPOINTS
</span></span><span class="line"><span class="cl">sda             8:0    <span class="m">0</span> 223.6G  <span class="m">0</span> disk
</span></span><span class="line"><span class="cl">└─sda1          8:1    <span class="m">0</span> 223.6G  <span class="m">0</span> part
</span></span><span class="line"><span class="cl">  └─games     254:0    <span class="m">0</span> 223.6G  <span class="m">0</span> crypt /games
</span></span><span class="line"><span class="cl">sdb             8:16   <span class="m">0</span> 931.5G  <span class="m">0</span> disk
</span></span><span class="line"><span class="cl">└─sdb1          8:17   <span class="m">0</span> 931.5G  <span class="m">0</span> part
</span></span><span class="line"><span class="cl">  └─data-hdd  254:2    <span class="m">0</span> 931.5G  <span class="m">0</span> crypt /data-hdd
</span></span><span class="line"><span class="cl">sdc             8:32   <span class="m">0</span> 931.5G  <span class="m">0</span> disk
</span></span><span class="line"><span class="cl">└─sdc1          8:33   <span class="m">0</span> 931.5G  <span class="m">0</span> part
</span></span><span class="line"><span class="cl">  └─data-hdd2 254:3    <span class="m">0</span> 931.5G  <span class="m">0</span> crypt /data-hdd2
</span></span><span class="line"><span class="cl">sdd             8:48   <span class="m">0</span> 465.8G  <span class="m">0</span> disk
</span></span><span class="line"><span class="cl">├─sdd1          8:49   <span class="m">0</span>   300M  <span class="m">0</span> part  /boot
</span></span><span class="line"><span class="cl">└─sdd2          8:50   <span class="m">0</span> 465.5G  <span class="m">0</span> part
</span></span><span class="line"><span class="cl">  └─root      254:1    <span class="m">0</span> 465.5G  <span class="m">0</span> crypt /
</span></span><span class="line"><span class="cl">sde             8:64   <span class="m">0</span> 931.5G  <span class="m">0</span> disk
</span></span><span class="line"><span class="cl">└─sde1          8:65   <span class="m">0</span> 931.5G  <span class="m">0</span> part
</span></span><span class="line"><span class="cl">  └─data-hdd3 254:4    <span class="m">0</span> 931.5G  <span class="m">0</span> crypt /data-hdd3
</span></span></code></pre></div><h2 id="auto-mounting-at-boot">Auto mounting at boot</h2>
<p>We&rsquo;ll need to add this disk to the kerenel parameters, /etc/crypttab and /etc/fstab. I haven&rsquo;t gotten round to switching to systemd boot yet, but I will do so very soon.</p>
<p>Open tmux and split the pane. In the bottom pane, run <code>lsblk -f</code> to have all the UUIDs listed. Then open the grub configuration file with <code>sudoedit /etc/default/grub</code></p>
<p><img loading="lazy" src="/luks1.png" type="" alt=""  /></p>
<p>You can discern which uuid to add from the listed examples. For my new disk, I needed to add the following:</p>
<p><code>rd.luks.name=3169af6c-a129-448e-b451-d7767866f607 data-hdd3=/dev/mapper/data-hdd3</code></p>
<p>Then run <code>sudo grub-mkconfig -o /boot/grub/grub.cfg</code> to update grub with the new settings. Adjust the path if you use a different path for your boot partition!</p>
<p>Next, we add it to /etc/crypttab</p>
<p><img loading="lazy" src="/luks2.png" type="" alt=""  /></p>
<p>To mount the new encrypted partition at boot, we add it to /etc/fstab.</p>
<p><strong>Note that this time we need to use the UUID of the partition located at /dev/mapper/data-hdd3</strong></p>
<p><img loading="lazy" src="/luks3.png" type="" alt=""  /></p>
<p>Use <code>sudo findmnt --verify</code> to check if there is antyhing wrong with the file.</p>
<p>Now you should be able to reboot and your new encrypted disk should be mounted automatically.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">(</span>ins<span class="o">)[</span>mischa@arch-beast ~<span class="o">]</span>$ lsblk
</span></span><span class="line"><span class="cl">NAME          MAJ:MIN RM   SIZE RO TYPE  MOUNTPOINTS
</span></span><span class="line"><span class="cl">sda             8:0    <span class="m">0</span> 223.6G  <span class="m">0</span> disk
</span></span><span class="line"><span class="cl">└─sda1          8:1    <span class="m">0</span> 223.6G  <span class="m">0</span> part
</span></span><span class="line"><span class="cl">  └─games     254:1    <span class="m">0</span> 223.6G  <span class="m">0</span> crypt /games
</span></span><span class="line"><span class="cl">sdb             8:16   <span class="m">0</span> 931.5G  <span class="m">0</span> disk
</span></span><span class="line"><span class="cl">└─sdb1          8:17   <span class="m">0</span> 931.5G  <span class="m">0</span> part
</span></span><span class="line"><span class="cl">  └─data-hdd  254:0    <span class="m">0</span> 931.5G  <span class="m">0</span> crypt /data-hdd
</span></span><span class="line"><span class="cl">sdc             8:32   <span class="m">0</span> 931.5G  <span class="m">0</span> disk
</span></span><span class="line"><span class="cl">└─sdc1          8:33   <span class="m">0</span> 931.5G  <span class="m">0</span> part
</span></span><span class="line"><span class="cl">  └─data-hdd2 254:4    <span class="m">0</span> 931.5G  <span class="m">0</span> crypt /data-hdd2
</span></span><span class="line"><span class="cl">sdd             8:48   <span class="m">0</span> 465.8G  <span class="m">0</span> disk
</span></span><span class="line"><span class="cl">├─sdd1          8:49   <span class="m">0</span>   300M  <span class="m">0</span> part  /boot
</span></span><span class="line"><span class="cl">└─sdd2          8:50   <span class="m">0</span> 465.5G  <span class="m">0</span> part
</span></span><span class="line"><span class="cl">  └─root      254:2    <span class="m">0</span> 465.5G  <span class="m">0</span> crypt /
</span></span><span class="line"><span class="cl">sde             8:64   <span class="m">0</span> 931.5G  <span class="m">0</span> disk
</span></span><span class="line"><span class="cl">└─sde1          8:65   <span class="m">0</span> 931.5G  <span class="m">0</span> part
</span></span><span class="line"><span class="cl">  └─data-hdd3 254:3    <span class="m">0</span> 931.5G  <span class="m">0</span> crypt /data-hdd3
</span></span></code></pre></div><h1 id="links">links</h1>
<p><a href="https://wiki.archlinux.org/title/Dm-crypt/Encrypting_an_entire_system#LUKS_on_a_partition">https://wiki.archlinux.org/title/Dm-crypt/Encrypting_an_entire_system#LUKS_on_a_partition</a></p>
<p><a href="https://wiki.archlinux.org/title/GRUB">https://wiki.archlinux.org/title/GRUB</a></p>
]]></content:encoded>
    </item>
    
  </channel>
</rss>
